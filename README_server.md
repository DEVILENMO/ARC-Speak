# ARC Speak Server 音频优化版

## 服务端音频处理功能

### 🎵 音频质量优化特性

1. **统一音频格式**
   - 标准采样率：48kHz
   - 标准声道：单声道
   - 数据类型：float32
   - 块大小控制：10ms-100ms

2. **智能音频处理**
   - **重采样**：自动将不同采样率的音频转换为48kHz
   - **范围检查**：检测并修复音频削波问题
   - **质量增强**：降噪和平滑处理
   - **格式验证**：确保音频数据完整性

3. **音频处理统计**
   - 处理块数统计
   - 重采样率统计
   - 处理成功率监控
   - 错误率追踪

### 🛠️ 安装和运行

1. **安装依赖**
```bash
pip install -r requirements.txt
```

2. **启动服务器**
```bash
python app.py
```

### 📊 音频处理API

#### 获取音频配置
```http
GET /api/audio/config
```
返回服务端支持的音频格式配置。

#### 音频处理测试
```http
POST /api/audio/test
Content-Type: application/json

{
    "audio_data": [0.1, 0.2, -0.1, ...],
    "metadata": {
        "samplerate": 44100,
        "channels": 1,
        "dtype": "float32"
    }
}
```

#### 音频统计（管理员）
```http
GET /api/audio/stats
```
获取音频处理统计信息。

#### 重置统计（管理员）
```http
POST /api/audio/stats/reset
```

### 🔧 关键音频处理功能

#### 1. 音频重采样
- 使用 scipy 进行高质量重采样（如果可用）
- 备用线性插值重采样
- 支持 22.05kHz、44.1kHz、48kHz 之间的转换

#### 2. 音频规范化
- 检测音频削波（>1.0 或 <-1.0）
- 自动规范化到有效范围
- 保持音频动态范围

#### 3. 音频增强
- 噪音阈值过滤（移除极小信号）
- 3点移动平均平滑
- 减少传输噪音

#### 4. 错误处理
- 音频数据验证
- 格式检查
- 异常恢复
- 客户端错误通知

### 🚀 性能优化

1. **块大小控制**
   - 最小块：480 samples (10ms @ 48kHz)
   - 最大块：4800 samples (100ms @ 48kHz)
   - 自动填充或截断

2. **处理效率**
   - NumPy 向量化操作
   - 批量处理
   - 内存优化

3. **实时监控**
   - 处理延迟统计
   - 质量指标追踪
   - 性能基准测试

### 🔍 问题诊断

#### 常见问题解决
1. **电音/杂音**：检查采样率是否一致
2. **音频中断**：验证块大小设置
3. **音质下降**：确认scipy已安装
4. **延迟过高**：调整块大小参数

#### 调试工具
- 音频处理日志
- 统计API监控
- 测试API验证
- 错误事件追踪

### 📝 配置选项

在 `app.py` 中可调整的参数：

```python
STANDARD_SAMPLERATE = 48000  # 目标采样率
STANDARD_CHANNELS = 1        # 声道数
MAX_AUDIO_CHUNK_SIZE = 4800  # 最大块大小
MIN_AUDIO_CHUNK_SIZE = 480   # 最小块大小
```

### 🔄 版本更新

- **v2.0**：添加音频处理和质量优化
- **v1.9**：统一音频格式支持
- **v1.8**：增加重采样功能
- **v1.7**：音频质量监控

音频优化显著改善了语音通话质量，消除了电音和杂音问题。 